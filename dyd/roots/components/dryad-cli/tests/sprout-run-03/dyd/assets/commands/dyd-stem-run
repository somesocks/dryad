#!/usr/bin/env bash

#
# turn this on to debug script
# set -x

#
# abort on error
# https://sipb.mit.edu/doc/safe-shell/
set -euf -o pipefail

SRC_DIR=$DYD_STEM
TEMP_DIR=''

# import assertion functions
. $SRC_DIR/dyd/assets/assertions.sh

_setup() {
	#
	# make a temporary working directory
	# this command is linux / osx agnostic
	# https://unix.stackexchange.com/questions/30091/fix-or-alternative-for-mktemp-in-os-x
	# echo "\[INFO\] creating temporary working directory" 1>&2;
	TEMP_DIR=''
	TEMP_DIR=`mktemp -d 2>/dev/null || mktemp -d -t 'build-dir'`
}

_prepare() {

	# copy the sample garden to the working directory
	cp -R "$SRC_DIR/dyd/assets/sample-garden/." "$TEMP_DIR"
	chmod -R 755 "$TEMP_DIR"

	cd "$TEMP_DIR"
	:;
}

_resolve_temp_dir() {
	if command -v realpath >/dev/null 2>&1; then
		TEMP_DIR=$(realpath "$TEMP_DIR")
		return
	fi
	if readlink -f "$TEMP_DIR" >/dev/null 2>&1; then
		TEMP_DIR=$(readlink -f "$TEMP_DIR")
		return
	fi
}

_test() {

	(dryad root build dyd/roots/root-01 --log-level="$DYD_LOG_LEVEL") 1>&2;
	_resolve_temp_dir

	# stdout/stderr should be joined by default
	set +e
	OUTPUT_JOINED=$(dryad sprout run "dyd/sprouts/root-01" --log-level="$DYD_LOG_LEVEL" -- 2>&1)
	STATUS=$?
	set -e
	if [ "$STATUS" -ne 0 ]; then
		echo "$OUTPUT_JOINED" 1>&2
		echo "[ERROR] Fail: sprout run (joined) exited with status $STATUS" 1>&2
		return 1
	fi
	case "$OUTPUT_JOINED" in
		*"STDOUT-OK"*)
			;;
		*)
			echo "[ERROR] Fail: expected joined output to contain STDOUT-OK" 1>&2
			return 1
			;;
	esac
	case "$OUTPUT_JOINED" in
		*"STDERR-OK"*)
			;;
		*)
			echo "[ERROR] Fail: expected joined output to contain STDERR-OK" 1>&2
			return 1
			;;
	esac

	# logging disables join
	LOG_DIR="logs"
	mkdir -p "$LOG_DIR"
	set +e
	OUTPUT_LOGGED=$(dryad sprout run "dyd/sprouts/root-01" \
		--log-stdout="$LOG_DIR" \
		--log-stderr="$LOG_DIR" \
		--log-level="$DYD_LOG_LEVEL" -- 2>&1)
	STATUS=$?
	set -e
	if [ "$STATUS" -ne 0 ]; then
		echo "$OUTPUT_LOGGED" 1>&2
		echo "[ERROR] Fail: sprout run (logged) exited with status $STATUS" 1>&2
		return 1
	fi
	case "$OUTPUT_LOGGED" in
		*"STDOUT-OK"*)
			echo "[ERROR] Fail: expected logged output to omit STDOUT-OK" 1>&2
			return 1
			;;
	esac
	case "$OUTPUT_LOGGED" in
		*"STDERR-OK"*)
			echo "[ERROR] Fail: expected logged output to omit STDERR-OK" 1>&2
			return 1
			;;
	esac
}

_verify() {
	assert_directory_exists "$TEMP_DIR/dyd"
	assert_file_content_equals "$TEMP_DIR/dyd/type" "garden"

	assert_file_exists "$TEMP_DIR/logs/dyd-stem-run--dyd-sprouts-root-01.out"
	assert_file_exists "$TEMP_DIR/logs/dyd-stem-run--dyd-sprouts-root-01.err"
	assert_file_content_equals "$TEMP_DIR/logs/dyd-stem-run--dyd-sprouts-root-01.out" "STDOUT-OK"
	assert_file_content_equals "$TEMP_DIR/logs/dyd-stem-run--dyd-sprouts-root-01.err" "STDERR-OK"

	:;
}

_teardown() {
	# echo "\[INFO\] tearing down fixtures" 1>&2;
	if [ -d "$TEMP_DIR" ]; then
		chmod -R 755 "$TEMP_DIR"
		rm -rf "$TEMP_DIR"
	fi
}

trap _teardown ERR EXIT
_setup
_prepare
_test
_verify
