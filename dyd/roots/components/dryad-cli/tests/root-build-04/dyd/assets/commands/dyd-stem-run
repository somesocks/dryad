#!/usr/bin/env bash

#
# turn this on to debug script
# set -x

#
# abort on error
# https://sipb.mit.edu/doc/safe-shell/
set -euf -o pipefail

SRC_DIR=$DYD_STEM
TEMP_DIR=''
ROOTS=("root-01" "root-02" "root-03" "root-04" "root-05")
EXPECTED_ROOT_TYPE_HEX=("726f6f740a" "20726f6f74" "726f6f7420" "0a726f6f74" "09726f6f7409")
BUILD_LOG_FILE=''

# import assertion functions
. $SRC_DIR/dyd/assets/assertions.sh

_setup() {
	#
	# make a temporary working directory
	# this command is linux / osx agnostic
	# https://unix.stackexchange.com/questions/30091/fix-or-alternative-for-mktemp-in-os-x
	# echo "\[INFO\] creating temporary working directory" 1>&2;
	TEMP_DIR=''
	TEMP_DIR=`mktemp -d 2>/dev/null || mktemp -d -t 'build-dir'`
	BUILD_LOG_FILE="$TEMP_DIR/build.log"
}

_prepare() {

	# echo "[INFO] creating garden" 1>&2;

	# copy the sample garden to the working directory
	cp -R "$SRC_DIR/dyd/assets/sample-garden/." "$TEMP_DIR" 
	chmod -R 755 "$TEMP_DIR"

	cd "$TEMP_DIR"
	:;
}

_test() {

	: > "$BUILD_LOG_FILE"
	for root_name in "${ROOTS[@]}"; do
		(dryad root build "dyd/roots/$root_name" --log-level="$DYD_LOG_LEVEL") >> "$BUILD_LOG_FILE" 2>&1;
	done
}

_verify() {
	assert_directory_exists "$TEMP_DIR/dyd"
	assert_file_content_equals "$TEMP_DIR/dyd/type" "garden"

	for index in "${!ROOTS[@]}"; do
		root_name="${ROOTS[$index]}"
		root_type_path="$TEMP_DIR/dyd/roots/$root_name/dyd/type"
		root_type_hex=$(od -An -t x1 "$root_type_path" | tr -d ' \n')
		if [ "$root_type_hex" != "${EXPECTED_ROOT_TYPE_HEX[$index]}" ]; then
			echo "[ERROR] Fail: root type file '$root_type_path' was modified (expected ${EXPECTED_ROOT_TYPE_HEX[$index]}, got $root_type_hex)" 1>&2
			return 1
		fi

		if ! grep -Fq "dyd/roots/$root_name/dyd/type" "$BUILD_LOG_FILE"; then
			echo "[ERROR] Fail: expected warning to mention relative sentinel path for $root_name" 1>&2
			return 1
		fi

		assert_directory_exists "$TEMP_DIR/dyd/sprouts/$root_name"
		assert_file_content_equals "$TEMP_DIR/dyd/sprouts/$root_name/dyd/type" "stem"
	done

	if ! grep -Fq "malformed sentinel file" "$BUILD_LOG_FILE"; then
		echo "[ERROR] Fail: expected warning about badly formatted sentinel whitespace" 1>&2
		return 1
	fi

	:;
}

_teardown() {
	# echo "\[INFO\] tearing down fixtures" 1>&2;
	if [ -d "$TEMP_DIR" ]; then
		chmod -R 755 "$TEMP_DIR"
		rm -rf "$TEMP_DIR"
	fi
}

trap _teardown ERR EXIT
_setup
_prepare
_test
_verify
