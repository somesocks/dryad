#!/usr/bin/env bash

set -euf -o pipefail

SRC_DIR=$DYD_STEM
TEMP_DIR=''
BUILD_LOG_FILE=''
EXPECTED_REQUIREMENT_HEX='726f6f743a2e2e2f2e2e2f2e2e2f726f6f742d30320a'

. "$SRC_DIR/dyd/assets/assertions.sh"

assert_symlink_exists() {
	path=$1
	if [ ! -L "$path" ]; then
		echo "[ERROR] Fail: expected symlink '$path'" 1>&2
		return 1
	fi
}

_setup() {
	TEMP_DIR=''
	TEMP_DIR=`mktemp -d 2>/dev/null || mktemp -d -t 'build-dir'`
	BUILD_LOG_FILE="$TEMP_DIR/build.log"
}

_prepare() {
	cp -R "$SRC_DIR/dyd/assets/sample-garden/." "$TEMP_DIR"
	chmod -R 755 "$TEMP_DIR"

	cd "$TEMP_DIR"
}

_test() {
	: > "$BUILD_LOG_FILE"
	(dryad root build "dyd/roots/root-01" --log-level="$DYD_LOG_LEVEL") >> "$BUILD_LOG_FILE" 2>&1
}

_verify() {
	requirements_path="$TEMP_DIR/dyd/sprouts/root-01/dyd/dependencies/stem/dyd/requirements/root-02"
	dependency_path="$TEMP_DIR/dyd/sprouts/root-01/dyd/dependencies/stem/dyd/dependencies/root-02"
	requirement_source_path="$TEMP_DIR/dyd/roots/root-01/dyd/requirements/root-02"
	dependency_target=$(readlink -f "$dependency_path")
	root2_stem_target=$(readlink -f "$TEMP_DIR/dyd/sprouts/root-02/dyd/dependencies/stem")

	assert_directory_exists "$requirements_path"
	assert_file_exists "$requirements_path/dyd/fingerprint"
	assert_file_exists "$requirements_path/dyd/traits/channel"
	assert_file_content_equals "$requirements_path/dyd/traits/channel" "stable"
	assert_file_exists "$TEMP_DIR/dyd/sprouts/root-01/dyd/dependencies/stem/dyd/assets/root-01.txt"
	assert_file_content_equals "$TEMP_DIR/dyd/sprouts/root-01/dyd/dependencies/stem/dyd/assets/root-01.txt" "root-01"

	assert_symlink_exists "$dependency_path"
	assert_directory_exists "$dependency_target"
	assert_file_content_equals "$dependency_target/dyd/type" "stem"
	assert_file_content_equals "$dependency_target/dyd/assets/root-02.txt" "root-02"
	assert_file_content_equals "$dependency_target/dyd/traits/channel" "stable"

	if [ "$dependency_target" != "$root2_stem_target" ]; then
		echo "[ERROR] Fail: dependency link should resolve to the same stem as sprout root-02" 1>&2
		return 1
	fi

	dependency_fingerprint=$(cat "$dependency_target/dyd/fingerprint")
	assert_file_content_equals "$requirements_path/dyd/fingerprint" "$dependency_fingerprint"

	if [ "$(basename "$dependency_target")" != "$dependency_fingerprint" ]; then
		echo "[ERROR] Fail: dependency stem path basename should match dyd/fingerprint" 1>&2
		return 1
	fi

	requirement_hex=$(od -An -t x1 "$requirement_source_path" | tr -d ' \n')
	if [ "$requirement_hex" != "$EXPECTED_REQUIREMENT_HEX" ]; then
		echo "[ERROR] Fail: requirement file '$requirement_source_path' was modified (expected $EXPECTED_REQUIREMENT_HEX, got $requirement_hex)" 1>&2
		return 1
	fi

	if ! grep -Fq "dyd/roots/root-01/dyd/requirements/root-02" "$BUILD_LOG_FILE"; then
		echo "[ERROR] Fail: expected warning to include requirement file path" 1>&2
		return 1
	fi

	if ! grep -Fq "malformed requirement file" "$BUILD_LOG_FILE"; then
		echo "[ERROR] Fail: expected warning for malformed requirement file whitespace" 1>&2
		return 1
	fi
}

_teardown() {
	if [ -d "$TEMP_DIR" ]; then
		chmod -R 755 "$TEMP_DIR"
		rm -rf "$TEMP_DIR"
	fi
}

trap _teardown ERR EXIT
_setup
_prepare
_test
_verify
