#!/usr/bin/env bash
set -euf -o pipefail

SRC_DIR=$DYD_STEM
TEMP_DIR=''

. $SRC_DIR/dyd/assets/assertions.sh

_setup() {
	TEMP_DIR=''
	TEMP_DIR=`mktemp -d 2>/dev/null || mktemp -d -t 'build-dir'`
}

_prepare() {
	cp -R "$SRC_DIR/dyd/assets/sample-garden/." "$TEMP_DIR"
	chmod -R 755 "$TEMP_DIR"
}

_test() {
	EDITOR_PATH="$TEMP_DIR/dyd/roots/root-01/dyd/commands/dev-editor"
	(cd "$TEMP_DIR" && dryad root develop start dyd/roots/root-01 --editor="$EDITOR_PATH" --log-level="$DYD_LOG_LEVEL") 1>&2
}

_verify() {
	STATUS_FILE="$TEMP_DIR/dyd/heap/root-develop-reset-01/status"
	EXPECTED=$(printf "?? dyd/assets/extra.txt\n" | sort)
	ACTUAL=$(cat "$STATUS_FILE" | sort)
	if [ "$ACTUAL" != "$EXPECTED" ]; then
		echo "[ERROR] Fail: expected status ($EXPECTED), got ($ACTUAL)" 1>&2
		return 1
	fi

	FILE_CONTENT=$(cat "$TEMP_DIR/dyd/heap/root-develop-reset-01/file")
	if [ "$FILE_CONTENT" != "base" ]; then
		echo "[ERROR] Fail: expected file content (base), got ($FILE_CONTENT)" 1>&2
		return 1
	fi

	if [ ! -f "$TEMP_DIR/dyd/heap/root-develop-reset-01/extra" ]; then
		echo "[ERROR] Fail: expected extra file marker" 1>&2
		return 1
	fi
}

_teardown() {
	if [ -d "$TEMP_DIR" ]; then
		chmod -R 755 "$TEMP_DIR"
		rm -rf "$TEMP_DIR"
	fi
}

trap _teardown ERR EXIT
_setup
_prepare
_test
_verify
